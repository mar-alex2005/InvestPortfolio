@model Invest.WebApp.Models.CacheViewModel
@using Invest.Core.Enums
@using Invest.WebApp.Models
@{
    Layout = null;
    ViewData["Title"] = "Cache";

    var cache = new Dictionary<CacheViewModel.Item, decimal?>();
    var cacheIn = Model.Operations.Where(x => x.Type == OperationType.CacheIn).ToList();

    foreach (var a in Model.Accounts)
    {
        foreach (var cur in (Currency[]) Enum.GetValues(typeof(Currency)))
        {
            cache.Add(new CacheViewModel.Item(cur, a.BitCode),
                cacheIn.Where(x => x.Type == OperationType.CacheIn && x.Account == a && x.Currency == cur).Sum(x => x.Summa));
        }
    }


    var cacheInIis = cacheIn.Where(x => x.AccountType == AccountType.Iis).Sum(x => x.Summa);
    var cacheInVbr = cacheIn.Where(x => x.AccountType == AccountType.VBr).Sum(x => x.Summa);
    var cacheInTotal = cacheIn.Sum(x => x.Summa);

    var cacheInIisBuy = Model.Operations.Where(x => x.AccountType == AccountType.Iis && x.Currency == Currency.Rur && x.Type == OperationType.Buy).Sum(x => x.Price * x.Qty);
    var cacheInVbrBuy = Model.Operations.Where(x => x.AccountType == AccountType.VBr && x.Currency == Currency.Rur && x.Type == OperationType.Buy).Sum(x => x.Price * x.Qty);

    var cacheInIisSell = Model.Operations.Where(x => x.AccountType == AccountType.Iis && x.Currency == Currency.Rur && x.Type == OperationType.Sell).Sum(x => x.Price * x.Qty);
    var cacheInVbrSell = Model.Operations.Where(x => x.AccountType == AccountType.VBr && x.Currency == Currency.Rur && x.Type == OperationType.Sell).Sum(x => x.Price * x.Qty);

    var rurComm = Model.Operations.Where(x => (x.Type == OperationType.Buy || x.Type == OperationType.Sell)
            && x.Currency == Currency.Rur
            && x.Stock != null && x.Stock.Currency == Currency.Rur)
        .ToList();

    var rurCommIis = rurComm.Where(x => x.AccountType == AccountType.Iis).Sum(x => x.Commission ?? 0m);
    var rurCommVbr = rurComm.Where(x => x.AccountType == AccountType.VBr).Sum(x => x.Commission ?? 0m);


    var rurDivs = Model.Operations.Where(x => x.Type == OperationType.Dividend && x.Currency == Currency.Rur);
    var rurDivsIis = rurDivs.Where(x => x.AccountType == AccountType.Iis).Sum(x => x.Summa);
    var rurDivsVbr = rurDivs.Where(x => x.AccountType == AccountType.VBr).Sum(x => x.Summa);

    var rurNdflIis = Model.Operations.Where(x => x.AccountType == AccountType.Iis && x.Type == OperationType.Ndfl && x.Currency == Currency.Rur).Sum(x => x.Summa);
    var rurNdflVbr = Model.Operations.Where(x => x.AccountType == AccountType.VBr && x.Type == OperationType.Ndfl && x.Currency == Currency.Rur).Sum(x => x.Summa);

    var usdBuyVbr = Model.Operations.Where(x => x.AccountType == AccountType.VBr && x.Type == OperationType.CurBuy && x.Currency == Currency.Usd).Sum(x => x.Summa);
    var usdSellVbr = Model.Operations.Where(x => x.AccountType == AccountType.VBr && x.Type == OperationType.CurSell && x.Currency == Currency.Usd).Sum(x => x.Summa);
}

<table class="tbl-cache-main">
<tr>
<td>
    <div id="divOperCache" style="overflow-y: scroll;">
        <table class="tbl-oper-cache">
        <tr>
            <th>Дата</th>
            <th>Acc</th>
            <th>Сумма</th>
            <th>Cur</th>
            <th>Прим.</th>
        </tr>
        @{  
            var lastday = DateTime.MinValue;
            foreach (var o in Model.Operations
                   .Where(x => x.Type == OperationType.CacheIn
                           || x.Type == OperationType.CacheOut
                           || x.Type == OperationType.Ndfl)
                   .OrderByDescending(x => x.Date).ThenByDescending(x => x.Index))
            {
                var sColor = "black";
                if (o.Type == OperationType.CacheOut) {
                    sColor = "green";
                }
                else if (o.Type == OperationType.Ndfl) {
                    sColor = "orange";
                }

                if (o.Date.Month != lastday.Month)
                {
                    <tr><td class="td-separator" colspan="5">@($"{o.Date:MMM, yy}")</td></tr>
                }
                <tr>
                    <td class="td-date">@($"{o.Date:dd.MM.yyyy}")</td>
                    <td class="td-date" title="(acc: @o.Account.BrokerName)">@o.Account.Id</td>
                    <td class="td-summa" title="@o.Comment" style="text-align:right; color: @sColor;">@($"{o.Summa:N2}")</td>
                    <td class="td-type">@o.Currency</td>
                    <td class="td-type">@o.Type.ToString()</td>
                </tr>

                lastday = o.Date;
            }
        }
        </table>
    </div>
</td>
    <td>
        <table>
        <tr>
            <td>
                <table class="tbl-cache-acc">
                    <caption>По счетам:</caption>
                    <tr>
                        <th></th>
                        @foreach (var a in Model.Accounts)
                        {
                            <th title="@a.Name">@a.BrokerName</th>
                        }
                        <th>Итого</th>
                    </tr>
                    <tr>
                        <td></td>
                        @{
                            foreach (var a in Model.Accounts)
                            {
                                var accountCacheIn = Model.Operations
                                    .Where(x => x.Type == OperationType.CacheIn && x.Currency == Currency.Rur && x.Account == a)
                                    .Sum(x => x.Summa);

                                <td class="acc-total">@($"{accountCacheIn:N2}")</td>
                            }

                            var totalCacheIn = Model.Operations
                                .Where(x => x.Type == OperationType.CacheIn && x.Currency == Currency.Rur)
                                .Sum(x => x.Summa);
                        }
                        <td class="acc-total-all">@(totalCacheIn != null && totalCacheIn != 0 ? $"{totalCacheIn:N2}" : "")</td>
                    </tr>
                    @{
                        foreach (var p in Invest.Core.Builder.GetPeriods())
                        {
                            <tr>
                                <td class="td-1">@p.Name</td>
                                @{
                                    foreach (var a in Model.Accounts)
                                    {
                                        var accountCacheIn = Model.Operations
                                            .Where(x => x.Type == OperationType.CacheIn && x.Currency == Currency.Rur
                                                && x.Account == a && x.Date.Year == p.Year && x.Date.Month == p.Month)
                                            .Sum(x => x.Summa);

                                        <td>@(accountCacheIn != null && accountCacheIn != 0 ? $"{accountCacheIn:N2}" : "-")</td>
                                    }

                                    var accountCacheInTotal = Model.Operations
                                        .Where(x => x.Type == OperationType.CacheIn && x.Currency == Currency.Rur
                                            && x.Date.Year == p.Year && x.Date.Month == p.Month)
                                        .Sum(x => x.Summa);
                                }
                                <td>@(accountCacheInTotal != null && accountCacheInTotal != 0 ? $"{accountCacheInTotal:N2}" : "")</td>
                            </tr>
                        }
                    }
                </table><br />
            </td>
        </tr>
        <tr>
            <td>
                <div style="border: 1px solid lightgrey; background-color:  #f0f0f0; padding: 7px;">
                    <div style="border: 1px solid lightgrey; background-color: white; padding: 14px; ">
                        <div id="chartCache" class="chart-cache"></div>
                    </div>
                </div>
                <br />
            </td>
        </tr>
        <tr>
            <td>
                <table class="tbl-h">
                    <tr>
                    <th></th>
                        @foreach (var va in Model.VirtualAccounts)
                        {
                            <th title="@va.Name" colspan="@Model.Accounts.Count(x => x.VirtualAccount == va)">@va.Id</th>
                        }
                        <th></th>
                    </tr>
                    <tr>
                        <th></th>
                        @foreach (var va in Model.VirtualAccounts) {
                            foreach (var a in Model.Accounts.Where(x => x.VirtualAccount == va))
                            {
                                <th>@a.BrokerName (@a.Id)</th>
                            }
                        }
                        <th>Total</th>
                    </tr>
                    <tr>
                        <td>CacheIn:</td>
                        <td class="td-cache"></td>
                        <td class="td-cache"></td>
                        <td class="td-cache-total"></td>
                    </tr>

                    @foreach (var cur in (Currency[]) Enum.GetValues(typeof(Currency))) 
                    {
                        <tr>
                            <td class="td-name-sub">@cur:</td>
                            @foreach (var a in Model.Accounts.OrderBy(x => x.VirtualAccount.SortIndex).ThenBy(x => x.SortIndex))
                            {
                                <td class="td-cache">@($"{cache[new CacheViewModel.Item(cur, a.BitCode)]:N2}")</td>
                            }
                        </tr>
                    }

                    <tr>
                        <td>Buys:</td>
                        <td class="td-cache-buy">@string.Format("{0:N2}", cacheInIisBuy)</td>
                        <td class="td-cache-buy">@string.Format("{0:N2}", cacheInVbrBuy)</td>
                        <td class="td-cache-total">@string.Format("{0:N2}", (cacheInIisBuy ?? 0) + (cacheInVbrBuy ?? 0))</td>
                    </tr>
                    <tr>
                        <td>Sells:</td>
                        <td class="td-cache-sell">@string.Format("{0:N2}", cacheInIisSell)</td>
                        <td class="td-cache-sell">@string.Format("{0:N2}", cacheInVbrSell)</td>
                        <td class="td-cache-total">@string.Format("{0:N2}", (cacheInIisSell ?? 0) + (cacheInVbrSell ?? 0))</td>
                    </tr>
                    <tr>
                        <td>Delta:</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisBuy - (cacheInIisSell ?? 0))</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInVbrBuy - (cacheInVbrSell ?? 0))</td>
                        <td></td>
                    </tr>
                    @{
                        var cacheInIisSaldo = cacheInIis - (cacheInIisBuy - (cacheInIisSell ?? 0));
                        var cacheInVbrSaldo = cacheInVbr - (cacheInVbrBuy - (cacheInVbrSell ?? 0));
                    }
                    <tr>
                        <td>Saldo:</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisSaldo)</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInVbrSaldo)</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisSaldo + cacheInVbrSaldo)</td>
                    </tr>
                    <tr>
                        <td>Comm:</td>
                        <td class="td-cache-comm">-@string.Format("{0:N2}", rurCommIis)</td>
                        <td class="td-cache-comm">-@string.Format("{0:N2}", rurCommVbr)</td>
                        <td class="td-cache">-@string.Format("{0:N2}", (rurCommIis + rurCommVbr))</td>
                    </tr>
                    <tr>
                        <td>=</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisSaldo - rurCommIis)</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInVbrSaldo - rurCommVbr)</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisSaldo + cacheInVbrSaldo - (rurCommIis + rurCommVbr))</td>
                    </tr>
                    <tr>
                        <td>Дивы:</td>
                        <td class="td-cache-divs">@string.Format("{0:N2}", rurDivsIis)</td>
                        <td class="td-cache-divs">@string.Format("{0:N2}", rurDivsVbr)</td>
                        <td class="td-cache-divs">@string.Format("{0:N2}", rurDivsIis + rurDivsVbr)</td>
                    </tr>
                    <tr>
                        <td>=</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisSaldo - rurCommIis + rurDivsIis)</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInVbrSaldo - rurCommVbr + rurDivsVbr)</td>
                        <td class="td-cache">@string.Format("{0:N2}", (cacheInIisSaldo - rurCommIis + rurDivsIis) + (cacheInVbrSaldo - rurCommVbr + rurDivsVbr))</td>
                    </tr>
                    <tr>
                        <td>ndfl:</td>
                        <td class="td-cache">@string.Format("{0:N2}", rurNdflIis)</td>
                        <td class="td-cache">@string.Format("{0:N2}", rurNdflVbr)</td>
                        <td class="td-cache">@string.Format("{0:N2}", (rurNdflIis ?? 0) + (rurNdflVbr ?? 0))</td>
                    </tr>
                    <tr>
                        <td>usd buy:</td>
                        <td class="td-cache">@string.Format("{0:N2}", 0)</td>
                        <td class="td-cache">@string.Format("{0:N2}", usdBuyVbr)</td>
                        <td class="td-cache">@string.Format("{0:N2}", (0) + (rurNdflVbr ?? 0))</td>
                    </tr> 
                    <tr>
                        <td>usd sell:</td>
                        <td class="td-cache">@string.Format("{0:N2}", 0)</td>
                        <td class="td-cache">@string.Format("{0:N2}", usdSellVbr)</td>
                        <td class="td-cache">@string.Format("{0:N2}", (0) + (usdSellVbr ?? 0))</td>
                    </tr> 
                    <tr>
                        <td>=</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInIisSaldo - rurCommIis + rurDivsIis - rurNdflIis)</td>
                        <td class="td-cache">@string.Format("{0:N2}", cacheInVbrSaldo - rurCommVbr + rurDivsVbr - rurNdflVbr - (usdBuyVbr- usdSellVbr)) </td>
                        <td class="td-cache">@string.Format("{0:N2}", (cacheInIisSaldo - rurCommIis + rurDivsIis - rurNdflIis) + (cacheInVbrSaldo - rurCommVbr + rurDivsVbr - rurNdflVbr - (usdBuyVbr - usdSellVbr)))</td>
                    </tr>
                </table>
            </td>
            </tr>
            </table>
        </td>
        <td>
            <table class="tbl-usd-ex">
            <caption>Usd ex:</caption>
            <tr>
                <th style="color: navy; text-align: center; background-color: #f0f0f0;"></th>
                <th style="color: navy; text-align: center; background-color: #f0f0f0;">Итого</th>
            </tr>
            <tr>
                <td>>></td>
                <td style="text-align:right; font-weight: bold;">
                    @{
                        var totalUsdExch = Model.Operations
                            .Where(x => x.Type == OperationType.UsdExchange)
                            .Sum(x => x.Summa);
                        }
                        @string.Format("{0:N2}", totalUsdExch)
                </td>
            </tr>
            @{
                var usdExchangeOps = Model.Operations
                    .Where(x => x.Type == OperationType.UsdExchange)
                    .OrderByDescending(x => x.Date);

                foreach (var o in usdExchangeOps)
                {
                    <tr>
                        <td class="td-1">@string.Format("{0:dd.MM.yyyy}", o.Date)</td>
                        <td style="text-align: right;">@($"{o.Summa:N2}")</td>
                        @*<td class="td-lot" style="text-align: right; color:darkgreen; padding-left:10px;">@string.Format("{0:N2}", accountCacheInTotal)</td>*@
                    </tr>
                }
            }
            </table>
        </td>
        <td>
            <table>
            <caption>Cur. operations</caption>
            @foreach (var va in Model.VirtualAccounts)
            {
                <tr>
                    <td style="font-weight: bold; padding: 6px;">@va.Id</td>
                </tr>
                <tr>
                    <td>
                    @foreach (var a in Model.Accounts.Where(x => x.VirtualAccount == va))
                    {
                        Model.Account = a;
                        foreach (var cur in Model.Currencies)
                        {
                            Model.Cur = cur;
                            if (Model.CurBuyOps[new CacheViewModel.Item(cur, a.BitCode)].Sum(x => x.Qty).Value != 0
                                || Model.CurSellOps[new CacheViewModel.Item(cur, a.BitCode)].Sum(x => x.Qty).Value != 0)
                            {
                                await Html.RenderPartialAsync("CurOperation", Model);
                                <div style="max-height: 360px; overflow-y: auto;">
                                    @{await Html.RenderPartialAsync("CurOperationByAccTbl", Model);}
                                </div>
                            }
                        }
                    }
                    </td>
                </tr>
            }
            </table>
        </td>
    </tr>
</table>